<html>
<head>
	<style>
	body {
		font-family: monospace;
        font-size: 13px;
        width: 620px;
	}

    h1, h2, h3 {
        font-size: 1em;
        margin: 0 0 1em 0;
        xdisplay: inline;
    }
    h1 {
        margin-top: 3em;
        margin-bottom: 2em;
        text-align: center;
    }
    p {
        margin: 0 0 1em 25px;
    }
    pre {
        white-space: pre-wrap;
    }
	</style>
</head>
<body>

<p><a href="index.html">[index]</a> <a href="index.html">[prev]</a> <a href="index.html">[next]</a></p>



<pre>
lowb1rd.github.io                                                          Nils
Category: Titanium, Ti.NetworkClient                                  July 2015
Blog Entry: 002
</pre>
<h1>                  Chunked Uploads with Titanium</h1>

<p>The request and the response of Titanium's HTTPClient (Ti.Network.HTTPClient) is built entirely in memory. This means that your app will crash with a memory exception when you try up- or downloading large data. It depends on the smartphone, but the trouble starts at about 100MB of request/response data.</p>

<h2>Status Quo</h2>
<p>For large resonse data (i.e. downloads), there is the <i>file</i> property of the HTTPClient object. This writes the response directly to that file avoiding memory issues. For the request part (i.e. upload), no such property exists. </p>

<p>The HTTPClient implementation for Android does detect file resources in the request data and streams directly from the file instead of loading it into memory.</p></p>

<h2>TiHTTPClient vs. APSHTTPClient</h2>
<p>Titanium did handle (and still does under Android) file uploads from a file handle well, but with the release of Titanium SDK 3.3.0, the TiHTTPClient was replaced by the APSHTTPClient lib [TIMOB-16883]. From there on, file uploads from a file handle were not streamed from the filesystem but converted to a blob. When the request was finally build in memory large blobs (files) cause the app to fail with memory error.</p>

<p>Before TiSDK3.3.0, the following code did manage large file uploads well. From TiDSK3.3.0 the file handle was converted to a blob making the build of the request fail for large files.</p>

    var file = Ti.Filesystem.getFile(..);
    var xhr = Ti.Network.HTTPCLient(..);
    xhr.send({
        data: file
    })

The APSHTTPClient library uses the common NSURLConnection and could be adopted to stream files from the filesystem instead of putting them in memory. I really tried to do it but things get quite complicated real quick when you have to craft the multipart HTTP POST request by yourself. And since the APSHTTPClient is an external lib, it's even harder to hack something into it. There has to be a simpler way..

<h2>What about chunking</h2>
The idea would be to split up large uploads in chunks, send them one by one to the server. Since a single chunk is small, there will be no memory issues. Another bonus is that if an upload request fails, you do not have to start all over again, but can retry from the current chunk.

Titanium has everything on board that is needed for chunking, mainly Ti.Buffer and Ti.Stream. Yay.

Let's assume we want to record a video from the camera with Ti.Media.ShowCamera() and upload that video to a server. Sounds easy enough - but it will fail for long videos <strong>under iOS</strong> because of the too large request body of the HTTPClient. For example, on an iPhone6, the app will crash when the recorded video is longer than 2 minutes.

<h2>Simple XHR upload example with file chunks</h2>

...

<h2>Server-Side</h2>

The server will just concatenate the chunks. PHP example

$file = $_FILES['data']['tmp_name'];
exec();

Please note that these examples are very basic and not meant for use in production. Chunks that failed to upload due to a connection problem should be retried. This makes chunked uploads also valuable for Android because the upload does not start from the very beginning every time a timeout occurs.



TiSDK 3.3.0 (TiHTTPClient)
Download 'file' property
Upload from file for android
Chunking is good because of retry
request failed, start all over again

other posts:

xhr retry
url cache


<i>--
(c) 2015 Nils Kraemer, last modified: 2015-07-06</i>


<h1>Comments</h1>



</body>

</html>
